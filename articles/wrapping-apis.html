<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="httr2">
<title>Wrapping APIs ‚Ä¢ httr2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="../deps/bs3compat-0.3.0/transition.js"></script><script src="../deps/bs3compat-0.3.0/tabs.js"></script><script src="../deps/bs3compat-0.3.0/bs3compat.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<link href="../syntax-highlighting.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Wrapping APIs">
<meta property="og:description" content="httr2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc" data-headroom>
    

      <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a class="navbar-brand mb-0 h1" href="../index.html">httr2</a>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <button type="button" id="version-badge" class="badge badge-default d-none d-lg-block" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Released version">0.1.0</button>

    <div id="navbar" class="collapse navbar-collapse">
      <ul class="navbar-nav mr-auto ml-3">
<li class="nav-item">
  <a class="nav-link" href="../articles/httr2.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/wrapping-apis.html">Wrapping APIs</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control mr-sm-2" aria-label="Search" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search..." autocomplete="off">
</form>

      <ul class="navbar-nav ml-1">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/httr2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
  </div>
</nav><div class="container template-article">
<script src="wrapping-apis_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <img src="" class="pkg-logo" alt=""><div class="page-header pb-2 mt-4 mb-2 border-bottom toc-ignore">
      <h1 class="display-4" data-toc-skip>Wrapping APIs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/httr2/blob/master/vignettes/wrapping-apis.Rmd" class="external-link"><code>vignettes/wrapping-apis.Rmd</code></a></small>
      <div class="d-none name"><code>wrapping-apis.Rmd</code></div>

    </div>

    
    
<p>A common use for httr2 is wrapping up a useful API and exposing it in an R package where each API endpoint (i.e.¬†a URL with parameters) becomes an R function with documented arguments. This vignette will show you how, starting with a very simple API that doesn‚Äôt need authentication, then slowly working up in complexity. Along the way, you‚Äôll learn about how to:</p>
<ul>
<li><p>Expose important details from HTTP errors in R errors.</p></li>
<li><p>Handle various types of authentication.</p></li>
<li><p>Consistently throttle the rate of requests or dynamically respond to rate limiting headers sent by the server.</p></li>
</ul>
<p>I assume you‚Äôre familiar with the basics of building a package. If not, you might want to read the ‚Äú<a href="https://r-pkgs.org/whole-game.html" class="external-link">The Whole Game</a>‚Äù chapter of <a href="https://r-pkgs.org" class="external-link">R packages</a> first.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://httr2.r-lib.org">httr2</a></span><span class="op">)</span></code></pre></div>
<div id="faker-api" class="section level2">
<h2 class="hasAnchor">
<a href="#faker-api" class="anchor" aria-hidden="true"></a>Faker API</h2>
<p>We‚Äôll start with a very simple API, <a href="https://fakerapi.it/en" class="external-link uri">faker API</a>, which provides a collection of techniques for generating fake data. Before we start writing the sort of functions that you might put in a package, we‚Äôll perform a request just to see how the basics work:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># We start by creating a request that uses the base API url</span>
<span class="va">req</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://fakerapi.it/api/v1"</span><span class="op">)</span>
<span class="va">resp</span> <span class="op">&lt;-</span> <span class="va">req</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># Then we add on the images path</span>
  <span class="fu"><a href="../reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"images"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># Add query parameters _width and _quantity</span>
  <span class="fu"><a href="../reference/req_url.html">req_url_query</a></span><span class="op">(</span>`_width` <span class="op">=</span> <span class="fl">380</span>, `_quantity` <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># The result comes back as JSON</span>
<span class="va">resp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; List of 4</span>
<span class="co">#&gt;  $ status: chr "OK"</span>
<span class="co">#&gt;  $ code  : int 200</span>
<span class="co">#&gt;  $ total : int 1</span>
<span class="co">#&gt;  $ data  :List of 1</span>
<span class="co">#&gt;   ..$ :List of 3</span>
<span class="co">#&gt;   .. ..$ title      : chr "Quia et aliquid voluptatem."</span>
<span class="co">#&gt;   .. ..$ description: chr "Quibusdam excepturi nesciunt ut saepe. Velit sit cum eum perspiciatis enim fugit. Eum sit molestias consectetur"| __truncated__</span>
<span class="co">#&gt;   .. ..$ url        : chr "http://placeimg.com/380/480/any"</span></code></pre></div>
<div id="errors" class="section level3">
<h3 class="hasAnchor">
<a href="#errors" class="anchor" aria-hidden="true"></a>Errors</h3>
<p>It‚Äôs always worth a little early experimentation to see if we get any useful information from errors. The httr2 defaults get in your way here, because if you retrieve an unsuccessful HTTP response, you automatically get an error that prevents you from further inspecting the body:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">req</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"invalid"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error: HTTP 404 Not Found.</span></code></pre></div>
<p>However, you can access the last response (successful or not) with <code><a href="../reference/last_response.html">last_response()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/last_response.html">last_response</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">resp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; $status</span>
<span class="co">#&gt; [1] "Not found"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $code</span>
<span class="co">#&gt; [1] 404</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $total</span>
<span class="co">#&gt; [1] 0</span></code></pre></div>
<p>It doesn‚Äôt look like there‚Äôs anything useful there. Sometimes useful info is returned in the headers, so let‚Äôs check:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/resp_headers.html">resp_headers</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; &lt;httr2_headers&gt;</span>
<span class="co">#&gt; Server: nginx</span>
<span class="co">#&gt; Content-Type: application/json</span>
<span class="co">#&gt; Transfer-Encoding: chunked</span>
<span class="co">#&gt; Connection: keep-alive</span>
<span class="co">#&gt; Vary: Accept-Encoding</span>
<span class="co">#&gt; X-Powered-By: PHP/7.3.16</span>
<span class="co">#&gt; Cache-Control: no-cache, private</span>
<span class="co">#&gt; Date: Thu, 23 Sep 2021 12:31:26 GMT</span>
<span class="co">#&gt; Access-Control-Allow-Origin: *</span>
<span class="co">#&gt; Access-Control-Allow-Methods: GET</span>
<span class="co">#&gt; Access-Control-Allow-Credentials: true</span>
<span class="co">#&gt; Access-Control-Max-Age: 86400</span>
<span class="co">#&gt; Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With</span>
<span class="co">#&gt; Content-Encoding: gzip</span></code></pre></div>
<p>It doesn‚Äôt look like we‚Äôre getting any more useful information, so we can leave the <code><a href="../reference/req_error.html">req_error()</a></code> default as is. We‚Äôll have another go later with an API that does provide more details.</p>
</div>
<div id="user-agent" class="section level3">
<h3 class="hasAnchor">
<a href="#user-agent" class="anchor" aria-hidden="true"></a>User agent</h3>
<p>If you‚Äôre wrapping this code into a package, it‚Äôs considered polite to set a user agent, so that, if your app accidentally does something horribly wrong, the developers of the website can figure out who to reach out to. You can do this with the <code><a href="../reference/req_user_agent.html">req_user_agent()</a></code> function:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">req</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/req_user_agent.html">req_user_agent</a></span><span class="op">(</span><span class="st">"my_package_name (http://my.package.web.site)"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_dry_run.html">req_dry_run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; GET /api/v1 HTTP/1.1</span>
<span class="co">#&gt; Host: fakerapi.it</span>
<span class="co">#&gt; User-Agent: my_package_name (http://my.package.web.site)</span>
<span class="co">#&gt; Accept: */*</span>
<span class="co">#&gt; Accept-Encoding: deflate, gzip, br</span></code></pre></div>
</div>
<div id="core-request-function" class="section level3">
<h3 class="hasAnchor">
<a href="#core-request-function" class="anchor" aria-hidden="true"></a>Core request function</h3>
<p>Once you‚Äôve made a few successful requests, it‚Äôs worth seeing if you can figure out the general pattern so you can wrap it up into a function that will become the core of your package.</p>
<p>For faker, I spent a little with the <a href="https://fakerapi.it/en#basic-usage" class="external-link">documentation</a> noting some commonalities:</p>
<ul>
<li><p>Every URL is of the form <code>https://fakerapi.it/api/v1/{resource}</code>, and data is passed to the resource with query parameters. All parameters start with <code>_</code>.</p></li>
<li><p>Every resource has three common query parameters: <code>_locale</code>, <code>_quantity</code>, and <code>_seed</code>.</p></li>
<li><p>All endpoints return JSON data.</p></li>
</ul>
<p>This lead me to construct the following function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">faker</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">resource</span>, <span class="va">...</span>, <span class="va">quantity</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">locale</span> <span class="op">=</span> <span class="st">"en_US"</span>, <span class="va">seed</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    <span class="va">...</span>,
    quantity <span class="op">=</span> <span class="va">quantity</span>,
    locale <span class="op">=</span> <span class="va">locale</span>,
    seed <span class="op">=</span> <span class="va">seed</span>
  <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span><span class="op">)</span>
  
  <span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://fakerapi.it/api/v1"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="va">resource</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/req_url.html">req_url_query</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">params</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/req_user_agent.html">req_user_agent</a></span><span class="op">(</span><span class="st">"my_package_name (http://my.package.web.site)"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu">faker</span><span class="op">(</span><span class="st">"images"</span>, width <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; List of 4</span>
<span class="co">#&gt;  $ status: chr "OK"</span>
<span class="co">#&gt;  $ code  : int 200</span>
<span class="co">#&gt;  $ total : int 1</span>
<span class="co">#&gt;  $ data  :List of 1</span>
<span class="co">#&gt;   ..$ :List of 3</span>
<span class="co">#&gt;   .. ..$ title      : chr "Nam omnis voluptatem rem ut."</span>
<span class="co">#&gt;   .. ..$ description: chr "Corrupti provident recusandae esse quis sapiente ex rerum. Explicabo et laudantium laboriosam architecto dolor "| __truncated__</span>
<span class="co">#&gt;   .. ..$ url        : chr "http://placeimg.com/300/480/any"</span></code></pre></div>
<p>I‚Äôve made a few important choices here:</p>
<ul>
<li><p>I‚Äôve decided to supply default values for the <code>quantity</code> and <code>locale</code> parameters. This makes my function easier to demo in this vignette.</p></li>
<li><p>I‚Äôve used a default of <code>NULL</code> for the <code>seed</code> argument. <code><a href="../reference/req_url.html">req_url_query()</a></code> will automatically drop <code>NULL</code> arguments so this means that no default value is sent to the API, but when you read the function definition you can still see that <code>seed</code> is accepted.</p></li>
<li><p>I automatically all prefix query parameters with <code>_</code> because argument names starting with <code>_</code> are hard to type in R.</p></li>
<li><p>My function generates the request, performs it, and extracts the body of the response. This works well for simple cases, but for more complex APIs you might want to return a request object that can be modified before being performed.</p></li>
</ul>
<p>I also used one cool trick: <code><a href="../reference/req_url.html">req_url_query()</a></code> uses <a href="https://rlang.r-lib.org/reference/dyn-dots.html" class="external-link">dynamic dots</a>, so we can use <code>!!!</code> to convert (e.g.) <code>req_url_query(req, !!!list(`_quantity` = 1, `_locale` = "en_US"))</code> into <code>req_url_query(req, `_quantity` = 1, `_locale` = "en_US")</code>.</p>
</div>
<div id="wrapping-individual-endpoints" class="section level3">
<h3 class="hasAnchor">
<a href="#wrapping-individual-endpoints" class="anchor" aria-hidden="true"></a>Wrapping individual endpoints</h3>
<p><code>faker()</code> is quite general ‚Äî it‚Äôs a good tool for the package developer because you can read the faker documentation and translate it to a function call. But it‚Äôs not very friendly for the package user who might not know anything about web APIs. So typically the next step in the process is to wrap up some individual endpoints with their own functions.</p>
<p>For example, let‚Äôs take the <code>persons</code> endpoint which has three additional parameters: <code>gender</code> (male or female), <code>birthday_start</code>, and <code>birthday_end</code>. A simple wrapper would start something like this:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">faker_person</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">gender</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">birthday_start</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">birthday_end</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">quantity</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">locale</span> <span class="op">=</span> <span class="st">"en_US"</span>, <span class="va">seed</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">faker</span><span class="op">(</span>
    <span class="st">"persons"</span>,
    gender <span class="op">=</span> <span class="va">gender</span>,
    birthday_start <span class="op">=</span> <span class="va">birthday_start</span>,
    birthday_end <span class="op">=</span> <span class="va">birthday_end</span>,
    quantity <span class="op">=</span> <span class="va">quantity</span>,
    locale <span class="op">=</span> <span class="va">locale</span>,
    seed <span class="op">=</span> <span class="va">seed</span>
  <span class="op">)</span>  
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu">faker_person</span><span class="op">(</span><span class="st">"male"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; List of 4</span>
<span class="co">#&gt;  $ status: chr "OK"</span>
<span class="co">#&gt;  $ code  : int 200</span>
<span class="co">#&gt;  $ total : int 1</span>
<span class="co">#&gt;  $ data  :List of 1</span>
<span class="co">#&gt;   ..$ :List of 9</span>
<span class="co">#&gt;   .. ..$ firstname: chr "Orin"</span>
<span class="co">#&gt;   .. ..$ lastname : chr "Harber"</span>
<span class="co">#&gt;   .. ..$ email    : chr "nhauck@yahoo.com"</span>
<span class="co">#&gt;   .. ..$ phone    : chr "+7025358654818"</span>
<span class="co">#&gt;   .. ..$ birthday : chr "1965-09-01"</span>
<span class="co">#&gt;   .. ..$ gender   : chr "male"</span>
<span class="co">#&gt;   .. ..$ address  :List of 9</span>
<span class="co">#&gt;   .. .. ..$ street        : chr "7830 Jackson Islands"</span>
<span class="co">#&gt;   .. .. ..$ streetName    : chr "Laurianne Alley"</span>
<span class="co">#&gt;   .. .. ..$ buildingNumber: chr "79329"</span>
<span class="co">#&gt;   .. .. ..$ city          : chr "New Francescaland"</span>
<span class="co">#&gt;   .. .. ..$ zipcode       : chr "51102-9292"</span>
<span class="co">#&gt;   .. .. ..$ country       : chr "Ireland"</span>
<span class="co">#&gt;   .. .. ..$ county_code   : chr "BM"</span>
<span class="co">#&gt;   .. .. ..$ latitude      : num 58.1</span>
<span class="co">#&gt;   .. .. ..$ longitude     : num -1.67</span>
<span class="co">#&gt;   .. ..$ website  : chr "http://hegmann.com"</span>
<span class="co">#&gt;   .. ..$ image    : chr "http://placeimg.com/640/480/people"</span></code></pre></div>
<p>We could make it more user friendly by checking the input types, and returning the result as a tibble. I did a quick and dirty conversion using purrr; depending on your needs you could use base R code or <code>tidyr::hoist()</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org" class="external-link">purrr</a></span><span class="op">)</span>

<span class="va">faker_person</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">gender</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">birthday_start</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">birthday_end</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">quantity</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">locale</span> <span class="op">=</span> <span class="st">"en_US"</span>, <span class="va">seed</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">gender</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">gender</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">birthday_start</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">birthday_start</span>, <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"`birthday_start` must be a date"</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="va">birthday_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">birthday_start</span>, <span class="st">"%Y-%m-%d"</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">birthday_end</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">birthday_end</span>, <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"`birthday_end` must be a date"</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="va">birthday_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">birthday_end</span>, <span class="st">"%Y-%m-%d"</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">json</span> <span class="op">&lt;-</span> <span class="fu">faker</span><span class="op">(</span>
    <span class="st">"persons"</span>,
    gender <span class="op">=</span> <span class="va">gender</span>,
    birthday_start <span class="op">=</span> <span class="va">birthday_start</span>,
    birthday_end <span class="op">=</span> <span class="va">birthday_end</span>,
    quantity <span class="op">=</span> <span class="va">quantity</span>,
    locale <span class="op">=</span> <span class="va">locale</span>,
    seed <span class="op">=</span> <span class="va">seed</span>
  <span class="op">)</span>  
  
  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>
    firstname <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_chr</a></span><span class="op">(</span><span class="va">json</span><span class="op">$</span><span class="va">data</span>, <span class="st">"firstname"</span><span class="op">)</span>,
    lastname <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_chr</a></span><span class="op">(</span><span class="va">json</span><span class="op">$</span><span class="va">data</span>, <span class="st">"lastname"</span><span class="op">)</span>,
    email <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_chr</a></span><span class="op">(</span><span class="va">json</span><span class="op">$</span><span class="va">data</span>, <span class="st">"email"</span><span class="op">)</span>,
    gender <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_chr</a></span><span class="op">(</span><span class="va">json</span><span class="op">$</span><span class="va">data</span>, <span class="st">"gender"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>
<span class="fu">faker_person</span><span class="op">(</span><span class="st">"male"</span>, quantity <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 √ó 4</span>
<span class="co">#&gt;   firstname lastname   email                         gender</span>
<span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt;      &lt;chr&gt;                         &lt;chr&gt; </span>
<span class="co">#&gt; 1 Gayle     Haley      daniela.lindgren@damore.com   male  </span>
<span class="co">#&gt; 2 Percival  Skiles     jaskolski.lurline@hotmail.com male  </span>
<span class="co">#&gt; 3 Deion     Keeling    ellsworth92@mraz.biz          male  </span>
<span class="co">#&gt; 4 Rex       Jakubowski gaylord.ayla@carroll.net      male  </span>
<span class="co">#&gt; 5 Jerrod    Abernathy  nikita20@skiles.org           male</span></code></pre></div>
<p>The next steps would be to export and document this function; I‚Äôll leave that up to you.</p>
</div>
</div>
<div id="secret-management" class="section level2">
<h2 class="hasAnchor">
<a href="#secret-management" class="anchor" aria-hidden="true"></a>Secret management</h2>
<p>We need to take a quick break from APIs to talk about secrets. Secrets are important, because every API (except for very simnple APIs like faker) is going to require that you identify yourself in some way, typically with an API key or a token. And even if you expect that your users will usually provide this information, you‚Äôre still going to need your own credentials in order to actually test your package.</p>
<p>This system is probably overkill if you only have one secret that you need to share in one or two places. But you almost invariably accumulate more secrets over time, and more people and computers that you need to share them with, so I think spending a little time to understand this system and set up it for your package will pay off in the long term.</p>
<div id="basics" class="section level3">
<h3 class="hasAnchor">
<a href="#basics" class="anchor" aria-hidden="true"></a>Basics</h3>
<p>httr2 provides <code><a href="../reference/secrets.html">secret_encrypt()</a></code> and <code><a href="../reference/secrets.html">secret_decrypt()</a></code> to scramble secrets so that you can include them in your public source code without worrying that others can read them. There are three basic steps to this process:</p>
<ol style="list-style-type: decimal">
<li>
<p>You create an <strong>encryption</strong> key with <code><a href="../reference/secrets.html">secret_make_key()</a></code> that is used to scramble and descramble secrets using symmetric cryptography:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/secrets.html">secret_make_key</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">key</span>
<span class="co">#&gt; [1] "SoXajx412Nb1wPLmCTDtZQ"</span></code></pre></div>
<p>(Note that <code><a href="../reference/secrets.html">secret_make_key()</a></code> uses a cryptographically secure random number generator provided by OpenSSL; it is not affected by R‚Äôs RNG settings, and there‚Äôs no way to make it reproducible.)</p>
</li>
<li>
<p>You scramble your secrets with <code><a href="../reference/secrets.html">secret_encrypt()</a></code> and store the resulting text directly in the source code of your package:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">secret_scrambled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/secrets.html">secret_encrypt</a></span><span class="op">(</span><span class="st">"secret I need to work with an API"</span>, <span class="va">key</span><span class="op">)</span>
<span class="va">secret_scrambled</span>
<span class="co">#&gt; [1] "tKccJN2KszCx55KGYOtt8V8HRn6DSyOKph7lzlGYpcIS2aXcji-zKDfio3ZoSCECrQ"</span></code></pre></div>
</li>
<li>
<p>When needed, you descramble the the secret using <code><a href="../reference/secrets.html">secret_decrypt()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/secrets.html">secret_decrypt</a></span><span class="op">(</span><span class="va">secret_scrambled</span>, <span class="va">key</span><span class="op">)</span>
<span class="co">#&gt; [1] "secret I need to work with an API"</span></code></pre></div>
</li>
</ol>
</div>
<div id="package-keys-and-secrets" class="section level3">
<h3 class="hasAnchor">
<a href="#package-keys-and-secrets" class="anchor" aria-hidden="true"></a>Package keys and secrets</h3>
<p>You can create any number of encryption keys, but I highly recommend that you create one key per package, which I‚Äôll call the <strong>package</strong> key. In this section, I‚Äôll show you how to store that key so that you (and your automated tests) can use it, but no one else can.</p>
<p>httr2 is built around the notion that this key should live in an environment variable. So the first step is to make your package key available on your local development machine by adding a line to your your user-level <code>.Renviron</code> (which you can easily open with <code>usethis::edit_r_environ()</code>):</p>
<pre><code>YOURPACKAGE_KEY=key_you_generated_with_secret_make_key</code></pre>
<p>Now (after you restart R), you‚Äôll be able to take advantage of a special <code><a href="../reference/secrets.html">secret_encrypt()</a></code> and <code><a href="../reference/secrets.html">secret_decrypt()</a></code> feature: the <code>key</code> argument can be the name of an environment variable, instead of the encryption key itself. In fact, this is most natural usage.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">secret_scrambled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/secrets.html">secret_encrypt</a></span><span class="op">(</span><span class="st">"secret I need to work with an API"</span>, <span class="st">"YOURPACKAGE_KEY"</span><span class="op">)</span>
<span class="va">secret_scrambled</span>
<span class="co">#&gt; [1] "M7VRLsOkdYDo3HV8Iy2AUNPiZk8-xkEMEd5Ug7mGl6jFb7QAGXwXuB4SbSQ4Xd_8TQ"</span>
<span class="fu"><a href="../reference/secrets.html">secret_decrypt</a></span><span class="op">(</span><span class="va">secret_scrambled</span>, <span class="st">"YOURPACKAGE_KEY"</span><span class="op">)</span>
<span class="co">#&gt; [1] "secret I need to work with an API"</span></code></pre></div>
<p>You‚Äôll also need to make the key available in your GitHub Actions (both check and pkgdown) so your automated tests can use it. This requires two steps:</p>
<ol style="list-style-type: decimal">
<li><p>Add the key to your <a href="https://docs.github.com/en/actions/reference/encrypted-secrets" class="external-link">repository secrets</a>.</p></li>
<li>
<p>Share the key with the workflows that need it by adding a line to the appropriate workflow:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb15-1"><a href="#cb15-1"></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="at">      </span><span class="fu">YOURPACKAGE_KEY</span><span class="kw">:</span><span class="at"> ${{ secrets.YOURPACKAGE_KEY }}</span></span></code></pre></div>
<p>You can see how httr2 does it in <a href="https://github.com/r-lib/httr2/blob/master/.github/workflows/R-CMD-check.yaml" class="external-link uri">its GitHub workflow</a>.</p>
</li>
</ol>
<p>Other continuous integration platforms will offer similar ways to make a key available as a secure environment variable.</p>
</div>
<div id="when-the-package-key-isnt-available" class="section level3">
<h3 class="hasAnchor">
<a href="#when-the-package-key-isnt-available" class="anchor" aria-hidden="true"></a>When the package key isn‚Äôt available</h3>
<p>There are a few important cases where your code won‚Äôt have access to your package key: on CRAN, on the personal machines of external contributors, and in automated checks on their PRs. So if you want to share your package on CRAN or make it easy for others to contribute, you need to make sure that your examples, vignettes, and tests all work without error:</p>
<ul>
<li><p>In vignettes, you can run <code>knitr::opts_chunk(eval = secret_has_key("YOURPACKAGE_KEY"))</code> so that chunks are only evaluated if your key is available.</p></li>
<li><p>In examples, you can surround code blocks that require your key with <code>if (httr2::secret_has_key("YOURPACKAGE_KEY")) {}</code></p></li>
<li><p>You don‚Äôt need to do anything in tests because when <code><a href="../reference/secrets.html">secret_decrypt()</a></code> is run by testhat, it will automatically <code>skip()</code> the test if the key isn‚Äôt available.</p></li>
</ul>
</div>
</div>
<div id="nytimes-books-api" class="section level2">
<h2 class="hasAnchor">
<a href="#nytimes-books-api" class="anchor" aria-hidden="true"></a>NYTimes Books API</h2>
<p>Next we‚Äôll take a look at the NYTimes <a href="https://developer.nytimes.com/docs/books-product/1/overview" class="external-link">Books API</a>. It requires a very simple authentication with an API key that‚Äôs included in every request. When you‚Äôre wrapping an API that has a key you‚Äôre going to face two struggles:</p>
<ul>
<li><p>How do you test your package without sharing your key with the whole world?</p></li>
<li><p>How do you allow your users to supply their own key, without having to pass it to every function?</p></li>
</ul>
<p>So now you can understand how the following code works to get my NYTimes Book API key:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/secrets.html">secret_decrypt</a></span><span class="op">(</span><span class="st">"4Nx84VPa83dMt3X6bv0fNBlLbv3U4D1kHM76YisKEfpCarBm1UHJHARwJHCFXQSV"</span>, <span class="st">"HTTR2_KEY"</span><span class="op">)</span></code></pre></div>
<p>I‚Äôll start by tackling the first problem because otherwise there‚Äôs no way for me to show how the API works in this vignette üòÉ. We‚Äôll come back to the second at the very end of this section, because it‚Äôs easiest to tackle once we have a function in place.</p>
<div id="security-considerations" class="section level3">
<h3 class="hasAnchor">
<a href="#security-considerations" class="anchor" aria-hidden="true"></a>Security considerations</h3>
<p>Note that including an API key as a query parameter is relatively insecure; if an API uses this method of auth, it‚Äôs typically because the key is relatively easy to create or gives relatively few privileges. Here it only takes a couple of minutes to generate your own NYTimes API key, so there‚Äôs little incentive for someone to try and steal yours.</p>
<p>The main problem of conveying credentials via the url is that it‚Äôs easily exposed, because httr2 makes no efforts to redact confidential information stored in query parameters. This means it‚Äôs relatively easy to leak your key if you use <code>req_perform(verbose = 1)</code>, <code><a href="../reference/req_dry_run.html">req_dry_run()</a></code>, or even just print the request object. And indeed, you‚Äôll see that in the examples below ‚Äî this is bad practice for a real package, but I think it‚Äôs ok here because the key doesn‚Äôt allow you to do anything valuable and it makes teaching APIs so much easier.</p>
</div>
<div id="basic-request" class="section level3">
<h3 class="hasAnchor">
<a href="#basic-request" class="anchor" aria-hidden="true"></a>Basic request</h3>
<p>Now let‚Äôs perform a test request and look at the response:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.nytimes.com/svc/books/v3"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"/reviews.json"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_query</a></span><span class="op">(</span>`api-key` <span class="op">=</span> <span class="va">my_key</span>, isbn <span class="op">=</span> <span class="fl">9780307476463</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">resp</span>
<span class="co">#&gt; &lt;httr2_response&gt;</span>
<span class="co">#&gt; GET</span>
<span class="co">#&gt; https://api.nytimes.com/svc/books/v3/reviews.json?api-key=qZ4iJAGzcL5drrRDErhTvuRalSlZxut4&amp;isbn=9780307476463</span>
<span class="co">#&gt; Status: 200 OK</span>
<span class="co">#&gt; Content-Type: application/json</span>
<span class="co">#&gt; Body: In memory (1349 bytes)</span></code></pre></div>
<p>Like most modern APIs, this one returns the results as JSON:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; List of 4</span>
<span class="co">#&gt;  $ status     : chr "OK"</span>
<span class="co">#&gt;  $ copyright  : chr "Copyright (c) 2021 The New York Times Company.  All Rights Reserved."</span>
<span class="co">#&gt;  $ num_results: int 2</span>
<span class="co">#&gt;  $ results    :List of 2</span>
<span class="co">#&gt;   ..$ :List of 9</span>
<span class="co">#&gt;   .. ..$ url           : chr "http://www.nytimes.com/2011/11/10/books/1q84-by-haruki-murakami-review.html"</span>
<span class="co">#&gt;   .. ..$ publication_dt: chr "2011-11-10"</span>
<span class="co">#&gt;   .. ..$ byline        : chr "JANET MASLIN"</span>
<span class="co">#&gt;   .. ..$ book_title    : chr "1Q84"</span>
<span class="co">#&gt;   .. ..$ book_author   : chr "Haruki Murakami"</span>
<span class="co">#&gt;   .. ..$ summary       : chr "In ‚Äú1Q84,‚Äù the Japanese novelist Haruki Murakami writes about characters in a Tokyo with two moons."</span>
<span class="co">#&gt;   .. ..$ uuid          : chr "00000000-0000-0000-0000-000000000000"</span>
<span class="co">#&gt;   .. ..$ uri           : chr "nyt://book/00000000-0000-0000-0000-000000000000"</span>
<span class="co">#&gt;   .. ..$ isbn13        :List of 9</span>
<span class="co">#&gt;   .. .. ..$ : chr "9780307476463"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9780307593313"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9780307957023"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9780345802934"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9781446484197"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9781446484203"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9781455830497"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9781469258843"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9788483832967"</span>
<span class="co">#&gt;   ..$ :List of 9</span>
<span class="co">#&gt;   .. ..$ url           : chr "http://www.nytimes.com/2011/11/06/books/review/1q84-by-haruki-murakami-translated-by-jay-rubin-and-philip-gabri"| __truncated__</span>
<span class="co">#&gt;   .. ..$ publication_dt: chr "2011-11-06"</span>
<span class="co">#&gt;   .. ..$ byline        : chr "KATHRYN SCHULZ"</span>
<span class="co">#&gt;   .. ..$ book_title    : chr "1Q84"</span>
<span class="co">#&gt;   .. ..$ book_author   : chr "Haruki Murakami"</span>
<span class="co">#&gt;   .. ..$ summary       : chr "Haruki Murakami has translated Raymond Chandler into Japanese, and there‚Äôs a lot of Marlowe to his madness."</span>
<span class="co">#&gt;   .. ..$ uuid          : chr "00000000-0000-0000-0000-000000000000"</span>
<span class="co">#&gt;   .. ..$ uri           : chr "nyt://book/00000000-0000-0000-0000-000000000000"</span>
<span class="co">#&gt;   .. ..$ isbn13        :List of 9</span>
<span class="co">#&gt;   .. .. ..$ : chr "9780307476463"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9780307593313"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9780307957023"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9780345802934"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9781446484197"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9781446484203"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9781455830497"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9781469258843"</span>
<span class="co">#&gt;   .. .. ..$ : chr "9788483832967"</span></code></pre></div>
<p>Before we start wrapping this up into a function, let‚Äôs consider what happens with errors.</p>
</div>
<div id="error-handling" class="section level3">
<h3 class="hasAnchor">
<a href="#error-handling" class="anchor" aria-hidden="true"></a>Error handling</h3>
<p>What happens if there‚Äôs an error? For example, if we deliberately supply an invalid key:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.nytimes.com/svc/books/v3"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"/reviews.json"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_query</a></span><span class="op">(</span>`api-key` <span class="op">=</span> <span class="st">"invalid"</span>, isbn <span class="op">=</span> <span class="fl">9780307476463</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error: HTTP 401 Unauthorized.</span></code></pre></div>
<p>To see if there‚Äôs any extra useful information we can again look at <code>last_response():</code></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/last_response.html">last_response</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">resp</span>
<span class="co">#&gt; &lt;httr2_response&gt;</span>
<span class="co">#&gt; GET</span>
<span class="co">#&gt; https://api.nytimes.com/svc/books/v3/reviews.json?api-key=invalid&amp;isbn=9780307476463</span>
<span class="co">#&gt; Status: 401 Unauthorized</span>
<span class="co">#&gt; Content-Type: application/json</span>
<span class="co">#&gt; Body: In memory (90 bytes)</span>
<span class="va">resp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; $fault</span>
<span class="co">#&gt; $fault$faultstring</span>
<span class="co">#&gt; [1] "Invalid ApiKey"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $fault$detail</span>
<span class="co">#&gt; $fault$detail$errorcode</span>
<span class="co">#&gt; [1] "oauth.v2.InvalidApiKey"</span></code></pre></div>
<p>It looks like there‚Äôs some useful additional info in the <code>faultstring</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">.</span><span class="op">$</span><span class="va">fault</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">.</span><span class="op">$</span><span class="va">faultstring</span>
<span class="co">#&gt; [1] "Invalid ApiKey"</span></code></pre></div>
<p>To add that information to future errors we can use the <code>body</code> argument to <code><a href="../reference/req_error.html">req_error()</a></code>. This should be a function that takes a response and returns a character vector of additional information to include in the error. Once we do that and re-fetch the request, we see the additional information displayed in the R error:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nytimes_error_body</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">resp</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">resp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">.</span><span class="op">$</span><span class="va">fault</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">.</span><span class="op">$</span><span class="va">faultstring</span>
<span class="op">}</span>

<span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.nytimes.com/svc/books/v3"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"/reviews.json"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_query</a></span><span class="op">(</span>`api-key` <span class="op">=</span> <span class="st">"invalid"</span>, isbn <span class="op">=</span> <span class="fl">9780307476463</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_error.html">req_error</a></span><span class="op">(</span>body <span class="op">=</span> <span class="va">nytimes_error_body</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error: HTTP 401 Unauthorized.</span>
<span class="co">#&gt; * Invalid ApiKey</span></code></pre></div>
</div>
<div id="rate-limits" class="section level3">
<h3 class="hasAnchor">
<a href="#rate-limits" class="anchor" aria-hidden="true"></a>Rate limits</h3>
<p>Another common source of errors is rate-limiting ‚Äî this is used by many servers to prevent one unruly client consuming too many resources. The <a href="https://developer.nytimes.com/faq#a11" class="external-link">frequently asked questions</a> page describes the rate limits for the NYT APIs:</p>
<blockquote>
<p>Yes, there are two rate limits per API: 4,000 requests per day and 10 requests per minute. You should sleep 6 seconds between calls to avoid hitting the per minute rate limit. If you need a higher rate limit, please contact us at <a href="mailto:code@nytimes.com" class="email">code@nytimes.com</a>.</p>
</blockquote>
<p>Many APIs return additional information about how long to wait when the rate limit is exceeded (often using the <code>Retry-After</code> header). So I deliberately violated the rate limit by quickly making 11 requests; unfortunately while the response was a standard 429 (Too many requests), it did not include any information about how long to wait in either the response body or the headers. That means we can‚Äôt use <code><a href="../reference/req_retry.html">req_retry()</a></code>, which automatically waits the amount of time the server requests. Instead, we‚Äôll use <code><a href="../reference/req_throttle.html">req_throttle()</a></code> to ensure we don‚Äôt make more than 10 requests every 60 seconds:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">req</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.nytimes.com/svc/books/v3"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"/reviews.json"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_query</a></span><span class="op">(</span>`api-key` <span class="op">=</span> <span class="st">"invalid"</span>, isbn <span class="op">=</span> <span class="fl">9780307476463</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_throttle.html">req_throttle</a></span><span class="op">(</span><span class="fl">10</span> <span class="op">/</span> <span class="fl">60</span><span class="op">)</span></code></pre></div>
<p>By default, <code><a href="../reference/req_throttle.html">req_throttle()</a></code> shares the limit across all requests made to the host (i.e.¬†<code>api.nytimes.com</code>). Since the docs suggest the rate limit applies per API, you might want to use the <code>realm</code> argument to be a bit more specific:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">req</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.nytimes.com/svc/books/v3"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"/reviews.json"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_query</a></span><span class="op">(</span>`api-key` <span class="op">=</span> <span class="st">"invalid"</span>, isbn <span class="op">=</span> <span class="fl">9780307476463</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_throttle.html">req_throttle</a></span><span class="op">(</span><span class="fl">10</span> <span class="op">/</span> <span class="fl">60</span>, realm <span class="op">=</span> <span class="st">"https://api.nytimes.com/svc/books"</span><span class="op">)</span></code></pre></div>
</div>
<div id="wrapping-it-up" class="section level3">
<h3 class="hasAnchor">
<a href="#wrapping-it-up" class="anchor" aria-hidden="true"></a>Wrapping it up</h3>
<p>Putting together all the pieces above yields a function something like this:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nytimes_books</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">api_key</span>, <span class="va">path</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.nytimes.com/svc/books/v3"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="st">"/reviews.json"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/req_url.html">req_url_query</a></span><span class="op">(</span><span class="va">...</span>, `api-key` <span class="op">=</span> <span class="va">api_key</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/req_error.html">req_error</a></span><span class="op">(</span>body <span class="op">=</span> <span class="va">nytimes_error_body</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/req_throttle.html">req_throttle</a></span><span class="op">(</span><span class="fl">10</span> <span class="op">/</span> <span class="fl">60</span>, realm <span class="op">=</span> <span class="st">"https://api.nytimes.com/svc/books"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">drunk</span> <span class="op">&lt;-</span> <span class="fu">nytimes_books</span><span class="op">(</span><span class="va">my_key</span>, <span class="st">"/reviews.json"</span>, isbn <span class="op">=</span> <span class="st">"0316453382"</span><span class="op">)</span>
<span class="va">drunk</span><span class="op">$</span><span class="va">results</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">summary</span>
<span class="co">#&gt; [1] "In ‚ÄúDrunk,‚Äù Edward Slingerland plays devil‚Äôs advocate for the pleasure and utility of Dionysian abandon."</span></code></pre></div>
<p>To finish this up for a real package, you‚Äôd want to:</p>
<ul>
<li><p>Add explicit arguments and check that they have the correct type.</p></li>
<li><p>Export and document the function.</p></li>
<li><p>Convert the nested list into a more user-friendly data structure (probably a data frame with one row per review).</p></li>
</ul>
<p>You‚Äôd also want to provide some convenient way for the user to supply their own API key.</p>
</div>
<div id="user-supplied-key" class="section level3">
<h3 class="hasAnchor">
<a href="#user-supplied-key" class="anchor" aria-hidden="true"></a>User-supplied key</h3>
<p>A good place to start is an environment variable, because environment variables are easy to set without typing anything in the console (which can get accidentally shared via your <code>.Rhistory</code>) and are easily set in automated processes. Then you‚Äôd write a function to retrieve the API key, returning a helpful message if it‚Äôs not found:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">get_api_key</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"NYTIMES_KEY"</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">key</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"No API key found, please supply with `api_key` argument or with NYTIMES_KEY env var"</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">key</span>
<span class="op">}</span></code></pre></div>
<p>Then you could modify <code>nytimes_books()</code> to use <code>get_api_key()</code> as the default value for <code>api_key</code>. Since the argument is now optional, we can move it to end of the argument list, since it‚Äôll only be needed in exceptional circumstances.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nytimes_books</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">path</span>, <span class="va">...</span>, <span class="va">api_key</span> <span class="op">=</span> <span class="fu">get_api_key</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">...</span>
<span class="op">}</span></code></pre></div>
<p>You can make this approach a little more user friendly by providing a helper that set‚Äôs the environment variable:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">set_api_key</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">key</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">key</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">key</span> <span class="op">&lt;-</span> <span class="fu">askpass</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/askpass/man/askpass.html" class="external-link">askpass</a></span><span class="op">(</span><span class="st">"Please enter your API key"</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span><span class="st">"NYTIMES_KEY"</span> <span class="op">=</span> <span class="va">key</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Using askpass (or similar) here is good practice since you don‚Äôt want to encourage the user to type their secret key into the console, as mentioned above.</p>
<p>It‚Äôs a good idea to extend <code>get_api_key()</code> to automatically use your encrypted key to make it easier to write tests:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">get_api_key</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"NYTIMES_KEY"</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">key</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">key</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="fu">is_testing</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">testing_key</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"No API key found, please supply with `api_key` argument or with NYTIMES_KEY env var"</span><span class="op">)</span> 
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">is_testing</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"TESTTHAT"</span><span class="op">)</span>, <span class="st">"true"</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">testing_key</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../reference/secrets.html">secret_decrypt</a></span><span class="op">(</span><span class="st">"4Nx84VPa83dMt3X6bv0fNBlLbv3U4D1kHM76YisKEfpCarBm1UHJHARwJHCFXQSV"</span>, <span class="st">"HTTR2_KEY"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
</div>
<div id="github-gists-api" class="section level2">
<h2 class="hasAnchor">
<a href="#github-gists-api" class="anchor" aria-hidden="true"></a>Github Gists API</h2>
<p>Next we‚Äôll take a look at an API that can make changes on behalf of a user, not just retrieve data: <a href="https://docs.github.com/en/rest/reference/gists" class="external-link">GitHub‚Äôs gist API</a>. This uses different HTTP methods to perform different actions, like creating, updating, and deleting gists. But before we can get to those, let‚Äôs handle authentication, rate-limiting, and errors.</p>
<div id="authentication" class="section level3">
<h3 class="hasAnchor">
<a href="#authentication" class="anchor" aria-hidden="true"></a>Authentication</h3>
<p>The easiest way to authenticate with a GitHub API is to use a personal access token. A token is an alternative to a username and password. You have one username + password per site; you can have one token per use case. This lets each use case have a minimal set of permissions, and you can easily revoke one token without affecting any other use case.</p>
<p>I created a personal access token specifically for this vignette that can only access gists, and, as in the last example, stored an encrypted version in this vignette:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">token</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/secrets.html">secret_decrypt</a></span><span class="op">(</span><span class="st">"Guz59woxKoIO_JVtp2IzU3mFIU3ULtaUEa8xvvpYUBdVthR8jhxzc3bMZFhA9HL-ZK6YZudOI6g"</span>, <span class="st">"HTTR2_KEY"</span><span class="op">)</span></code></pre></div>
<p>If you want to run this vignette yourself, you‚Äôll need to create a new token in your <a href="https://github.com/settings/tokens" class="external-link">GitHub settings</a>; just make sure it includes the ‚Äúgist‚Äù scope. It‚Äôs also a good idea to give every token a descriptive name, that reminds you of its motivating use case.</p>
<p>To authenticate a request with the token, we need to put it in the <code>Authorization</code> header with a <a href="https://docs.github.com/en/rest/overview/resources-in-the-rest-api#authentication" class="external-link">‚Äútoken‚Äù prefix</a>:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">req</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.github.com/gists"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_headers.html">req_headers</a></span><span class="op">(</span>Authorization <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"token"</span>, <span class="va">token</span><span class="op">)</span><span class="op">)</span>

<span class="va">req</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; &lt;httr2_response&gt;</span>
<span class="co">#&gt; GET https://api.github.com/gists</span>
<span class="co">#&gt; Status: 200 OK</span>
<span class="co">#&gt; Content-Type: application/json</span>
<span class="co">#&gt; Body: In memory (68160 bytes)</span></code></pre></div>
<p>Because the authorization header usually contains secret information, httr2 automatically redacts it<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Again, it‚Äôs still possible to extract it with a little extra work, but httr2 tries to help you avoid revealing it by accident. httr2 protects you from yourself, not from someone deliberately trying to find the secret.&lt;/p&gt;"><sup>1</sup></a>:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">req</span>
<span class="co">#&gt; &lt;httr2_request&gt;</span>
<span class="co">#&gt; GET https://api.github.com/gists</span>
<span class="co">#&gt; Headers:</span>
<span class="co">#&gt; ‚Ä¢ Authorization: '&lt;REDACTED&gt;'</span>
<span class="co">#&gt; Body: empty</span>
<span class="va">req</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/req_dry_run.html">req_dry_run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; GET /gists HTTP/1.1</span>
<span class="co">#&gt; Host: api.github.com</span>
<span class="co">#&gt; User-Agent: httr2/0.1.0 r-curl/4.3.2 libcurl/7.68.0</span>
<span class="co">#&gt; Accept: */*</span>
<span class="co">#&gt; Accept-Encoding: deflate, gzip, br</span>
<span class="co">#&gt; Authorization: &lt;REDACTED&gt;</span></code></pre></div>
</div>
<div id="errors-1" class="section level3">
<h3 class="hasAnchor">
<a href="#errors-1" class="anchor" aria-hidden="true"></a>Errors</h3>
<p>Once you‚Äôve got authentication working, it‚Äôs always a good idea to work on errors next, since that will help you debug any failed requests. In my experience APIs rarely do a good job of documenting their errors, so you‚Äôll often have to do a little experimentation. To add to the pain, in large APIs different endpoints often return different amounts of information in different forms. You‚Äôll typically need to tackle your error handling iteratively, improving your code each time you encounter a new problem.</p>
<p>While GitHub does <a href="https://docs.github.com/en/rest/overview/resources-in-the-rest-api#client-errors" class="external-link">document its errors</a>, I‚Äôm sufficiently distrustful that I still want to construct a deliberately malformed query and see what happens:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.github.com/gists"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_query</a></span><span class="op">(</span>since <span class="op">=</span> <span class="st">"abcdef"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_headers.html">req_headers</a></span><span class="op">(</span>Authorization <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"token"</span>, <span class="va">token</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error: HTTP 422 Unprocessable Entity.</span></code></pre></div>
<p>As documented I get a 422 ‚ÄúUnprocessable Entity‚Äù error. But the response is rather different to documentation which suggests there should be a string <code>message</code> and a list of <code>errors</code>:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/last_response.html">last_response</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">resp</span>
<span class="co">#&gt; &lt;httr2_response&gt;</span>
<span class="co">#&gt; GET https://api.github.com/gists?since=abcdef</span>
<span class="co">#&gt; Status: 422 Unprocessable Entity</span>
<span class="co">#&gt; Content-Type: application/json</span>
<span class="co">#&gt; Body: In memory (156 bytes)</span>
<span class="va">resp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; $message</span>
<span class="co">#&gt; [1] "Invalid since parameter: 'abcdef'. Must be an ISO 8601 timestamp."</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $documentation_url</span>
<span class="co">#&gt; [1] "https://docs.github.com/v3/gists/#parameters"</span></code></pre></div>
<p>I‚Äôll proceed anyway, writing a function that extracts the data and formats it for presentation to the user:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gist_error_body</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">resp</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">body</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="va">resp</span><span class="op">)</span>
  
  <span class="va">message</span> <span class="op">&lt;-</span> <span class="va">body</span><span class="op">$</span><span class="va">message</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">body</span><span class="op">$</span><span class="va">documentation_url</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">message</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">message</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"See docs at &lt;"</span>, <span class="va">body</span><span class="op">$</span><span class="va">documentation_url</span>, <span class="st">"&gt;"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">message</span>
<span class="op">}</span>
<span class="fu">gist_error_body</span><span class="op">(</span><span class="va">resp</span><span class="op">)</span>
<span class="co">#&gt; [1] "Invalid since parameter: 'abcdef'. Must be an ISO 8601 timestamp."</span>
<span class="co">#&gt; [2] "See docs at &lt;https://docs.github.com/v3/gists/#parameters&gt;"</span></code></pre></div>
<p>Now I can pass this function to the <code>body</code> argument of <code><a href="../reference/req_error.html">req_error()</a></code> and it will be automatically included in the error when a request fails:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.github.com/gists"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_query</a></span><span class="op">(</span>since <span class="op">=</span> <span class="st">"yesterday"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_headers.html">req_headers</a></span><span class="op">(</span>Authorization <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"token"</span>, <span class="va">token</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_error.html">req_error</a></span><span class="op">(</span>body <span class="op">=</span> <span class="va">gist_error_body</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error: HTTP 422 Unprocessable Entity.</span>
<span class="co">#&gt; * Invalid since parameter: 'yesterday'. Must be an ISO 8601 timestamp.</span>
<span class="co">#&gt; * See docs at &lt;https://docs.github.com/v3/gists/#parameters&gt;</span></code></pre></div>
<p>Notice that each element of the character vector produced by <code>gh_error_body()</code> becomes a bullet in the resulting error.</p>
</div>
<div id="rate-limiting" class="section level3">
<h3 class="hasAnchor">
<a href="#rate-limiting" class="anchor" aria-hidden="true"></a>Rate-limiting</h3>
<p>While we‚Äôre thinking about errors, it‚Äôs useful to look at what happens if the requests are rate limited. Luckily, GitHub consistently uses response headers to provide information about the remaining <a href="https://docs.github.com/en/rest/overview/resources-in-the-rest-api#rate-limiting" class="external-link">rate limits</a>.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span> <span class="va">req</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> 
<span class="va">resp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/resp_headers.html">resp_headers</a></span><span class="op">(</span><span class="st">"ratelimit"</span><span class="op">)</span>
<span class="co">#&gt; &lt;httr2_headers&gt;</span>
<span class="co">#&gt; x-ratelimit-limit: 5000</span>
<span class="co">#&gt; x-ratelimit-remaining: 4970</span>
<span class="co">#&gt; x-ratelimit-reset: 1632401606</span>
<span class="co">#&gt; x-ratelimit-used: 30</span>
<span class="co">#&gt; x-ratelimit-resource: core</span></code></pre></div>
<p>We can teach httr2 about this so it can automatically wait for a reset if the rate limit is hit. We need to define two functions. The first tells us whether or not a response has a transient error, i.e.¬†it‚Äôs worth waiting and trying again. For GitHub, when the rate limit is <a href="https://docs.github.com/en/rest/overview/resources-in-the-rest-api#rate-limiting" class="external-link">exceeded</a>, the response has a 403 status and a <code>X-RateLimit-Remaining: 0</code> header:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gist_is_transient</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">resp</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../reference/resp_status.html">resp_status</a></span><span class="op">(</span><span class="va">resp</span><span class="op">)</span> <span class="op">==</span> <span class="fl">403</span> <span class="op">&amp;&amp;</span> 
    <span class="fu"><a href="../reference/resp_headers.html">resp_header</a></span><span class="op">(</span><span class="va">resp</span>, <span class="st">"X-RateLimit-Remaining"</span><span class="op">)</span> <span class="op">==</span> <span class="st">"0"</span>
<span class="op">}</span>
<span class="fu">gist_is_transient</span><span class="op">(</span><span class="va">resp</span><span class="op">)</span>
<span class="co">#&gt; [1] FALSE</span></code></pre></div>
<p>Then we need a function tells how long to wait. GitHub tells us when the rate limit resets (as number of seconds since 1970-01-01) in the <code>X-RateLimit-Reset</code> header. To convert that to a number of seconds to wait we first convert it to a number (since HTTP headers are always strings), then subtract off the current time (in number of seconds since 1970-01-01):</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gist_after</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">resp</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="../reference/resp_headers.html">resp_header</a></span><span class="op">(</span><span class="va">resp</span>, <span class="st">"X-RateLimit-Reset"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">time</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">gist_after</span><span class="op">(</span><span class="va">resp</span><span class="op">)</span>
<span class="co">#&gt; [1] 1312.293</span></code></pre></div>
<p>We then pass functions to <code><a href="../reference/req_retry.html">req_retry()</a></code> so httr2 has all the information it needs to handle rate-limiting automatically:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"http://api.github.com"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/req_retry.html">req_retry</a></span><span class="op">(</span>
    is_transient <span class="op">=</span> <span class="va">gist_is_transient</span>,
    after <span class="op">=</span> <span class="va">gist_after</span>,
    max_seconds <span class="op">=</span> <span class="fl">60</span>
  <span class="op">)</span>
<span class="co">#&gt; &lt;httr2_request&gt;</span>
<span class="co">#&gt; GET http://api.github.com</span>
<span class="co">#&gt; Body: empty</span>
<span class="co">#&gt; Policies:</span>
<span class="co">#&gt; ‚Ä¢ retry_max_wait: 60</span>
<span class="co">#&gt; ‚Ä¢ retry_is_transient: a function</span>
<span class="co">#&gt; ‚Ä¢ retry_after: a function</span></code></pre></div>
<p>You also need to supply either <code>max_tries</code> or <code>max_seconds</code> in order to activate <code><a href="../reference/req_retry.html">req_retry()</a></code>.</p>
</div>
<div id="wrapping-it-all-up" class="section level3">
<h3 class="hasAnchor">
<a href="#wrapping-it-all-up" class="anchor" aria-hidden="true"></a>Wrapping it all up</h3>
<p>Let‚Äôs wrap up everything we‚Äôve learned so far into a single function that creates a request:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">req_gist</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">token</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.github.com/gists"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/req_headers.html">req_headers</a></span><span class="op">(</span>Authorization <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"token"</span>, <span class="va">token</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/req_error.html">req_error</a></span><span class="op">(</span>body <span class="op">=</span> <span class="va">gist_error_body</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="../reference/req_retry.html">req_retry</a></span><span class="op">(</span>
      is_transient <span class="op">=</span> <span class="va">gist_is_transient</span>,
      after <span class="op">=</span> <span class="va">gist_after</span>
    <span class="op">)</span>
<span class="op">}</span>

<span class="co"># Check it works:</span>
<span class="fu">req_gist</span><span class="op">(</span><span class="va">token</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; &lt;httr2_response&gt;</span>
<span class="co">#&gt; GET https://api.github.com/gists</span>
<span class="co">#&gt; Status: 200 OK</span>
<span class="co">#&gt; Content-Type: application/json</span>
<span class="co">#&gt; Body: In memory (68160 bytes)</span></code></pre></div>
<p>We‚Äôll use this as the basis to solve the next challenge: uploading a gist.</p>
</div>
<div id="sending-data" class="section level3">
<h3 class="hasAnchor">
<a href="#sending-data" class="anchor" aria-hidden="true"></a>Sending data</h3>
<p>To <a href="https://docs.github.com/en/rest/reference/gists#create-a-gist" class="external-link">create a gist</a> we need to change the method to <code>POST</code> and add a body that contains data encoded as JSON. httr2 provides one function that does both of these things: <code><a href="../reference/req_body.html">req_body_json()</a></code>:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">req</span> <span class="op">&lt;-</span> <span class="fu">req_gist</span><span class="op">(</span><span class="va">token</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_body.html">req_body_json</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    description <span class="op">=</span> <span class="st">"This is my cool gist!"</span>,
    files <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>test.R <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>content <span class="op">=</span> <span class="st">"print('Hi!')"</span><span class="op">)</span><span class="op">)</span>,
    public <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span><span class="op">)</span>
<span class="va">req</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/req_dry_run.html">req_dry_run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; POST /gists HTTP/1.1</span>
<span class="co">#&gt; Host: api.github.com</span>
<span class="co">#&gt; User-Agent: httr2/0.1.0 r-curl/4.3.2 libcurl/7.68.0</span>
<span class="co">#&gt; Accept: */*</span>
<span class="co">#&gt; Accept-Encoding: deflate, gzip, br</span>
<span class="co">#&gt; Authorization: &lt;REDACTED&gt;</span>
<span class="co">#&gt; Content-Type: application/json</span>
<span class="co">#&gt; Content-Length: 100</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; {"description":"This is my cool gist!","files":{"test.R":{"content":"print('Hi!')"}},"public":false}</span></code></pre></div>
<p>Depending on the API you‚Äôre wrapping, you might need to send data in a different way. <code><a href="../reference/req_body.html">req_body_form()</a></code> and <code><a href="../reference/req_body.html">req_body_multipart()</a></code> make it easier to encode data in two other common forms. If the API requires something different you can use <code><a href="../reference/req_body.html">req_body_raw()</a></code>.</p>
<p>Typically, the API will return some useful data about the resource you‚Äôve just created. Here I‚Äôll extract the gist ID so we can use it in the next examples, culminating with deleting the gist so I don‚Äôt end up with a bunch of duplicated gists üòÉ.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">resp</span> <span class="op">&lt;-</span> <span class="va">req</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">id</span> <span class="op">&lt;-</span> <span class="va">resp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="va">.</span><span class="op">$</span><span class="va">id</span>
<span class="va">id</span>
<span class="co">#&gt; [1] "6de840e7f208a167ee4e7a5d75554ff4"</span></code></pre></div>
</div>
<div id="changing-a-gist" class="section level3">
<h3 class="hasAnchor">
<a href="#changing-a-gist" class="anchor" aria-hidden="true"></a>Changing a gist</h3>
<p>Actually, that description wasn‚Äôt very true and I want to change it. To do so, I need to again send JSON encoded data, but this time I need to use the <code>PATCH</code> verb. So after adding the data to request, I use <code><a href="../reference/req_method.html">req_method()</a></code> to override the default method:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">req</span> <span class="op">&lt;-</span> <span class="fu">req_gist</span><span class="op">(</span><span class="va">token</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_body.html">req_body_json</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>description <span class="op">=</span> <span class="st">"This is a lame gist"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_method.html">req_method</a></span><span class="op">(</span><span class="st">"PATCH"</span><span class="op">)</span>
<span class="va">req</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/req_dry_run.html">req_dry_run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; PATCH /gists/6de840e7f208a167ee4e7a5d75554ff4 HTTP/1.1</span>
<span class="co">#&gt; Host: api.github.com</span>
<span class="co">#&gt; User-Agent: httr2/0.1.0 r-curl/4.3.2 libcurl/7.68.0</span>
<span class="co">#&gt; Accept: */*</span>
<span class="co">#&gt; Accept-Encoding: deflate, gzip, br</span>
<span class="co">#&gt; Authorization: &lt;REDACTED&gt;</span>
<span class="co">#&gt; Content-Type: application/json</span>
<span class="co">#&gt; Content-Length: 37</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; {"description":"This is a lame gist"}</span></code></pre></div>
</div>
<div id="deleting-a-gist" class="section level3">
<h3 class="hasAnchor">
<a href="#deleting-a-gist" class="anchor" aria-hidden="true"></a>Deleting a gist</h3>
<p>Deleting a gist is similar, except we don‚Äôt send any data, we just need to adjust the default method from <code>GET</code> to <code>DELETE</code>.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">req</span> <span class="op">&lt;-</span> <span class="fu">req_gist</span><span class="op">(</span><span class="va">token</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_url.html">req_url_path_append</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_method.html">req_method</a></span><span class="op">(</span><span class="st">"DELETE"</span><span class="op">)</span>
<span class="va">req</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/req_dry_run.html">req_dry_run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; DELETE /gists/6de840e7f208a167ee4e7a5d75554ff4 HTTP/1.1</span>
<span class="co">#&gt; Host: api.github.com</span>
<span class="co">#&gt; User-Agent: httr2/0.1.0 r-curl/4.3.2 libcurl/7.68.0</span>
<span class="co">#&gt; Accept: */*</span>
<span class="co">#&gt; Accept-Encoding: deflate, gzip, br</span>
<span class="co">#&gt; Authorization: &lt;REDACTED&gt;</span>
<span class="va">req</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; &lt;httr2_response&gt;</span>
<span class="co">#&gt; DELETE https://api.github.com/gists/6de840e7f208a167ee4e7a5d75554ff4</span>
<span class="co">#&gt; Status: 204 No Content</span></code></pre></div>
</div>
</div>
<div id="oauth" class="section level2">
<h2 class="hasAnchor">
<a href="#oauth" class="anchor" aria-hidden="true"></a>OAuth</h2>
<p>If the API provides access to a website where the user already has an account (think Twitter, Instagram, Facebook, Google, GitHub, etc), it‚Äôs likely to use OAuth to allow you to authorise on behalf of the user. OAuth<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Here I‚Äôll only talk about OAuth 2.0 which is the only version in common use today. OAuth 1.0 is largely only of historical interest.&lt;/p&gt;"><sup>2</sup></a> is an authorisation framework that‚Äôs designed so that you don‚Äôt have to share your username and password with an app; instead the app asks for permission to use your account. You‚Äôve almost certainly used this before on the web; it‚Äôs used in most cases where one website wants to use another website on your behalf.</p>
<p>OAuth is a broad framework that‚Äôs has many many many different variants which makes it hard to provide generalisable advice. The following advice draws on my experience working with a number of OAuth using APIs, but don‚Äôt be surprised if you need to do something slightly different for the API you‚Äôre working with.</p>
<div id="clients" class="section level3">
<h3 class="hasAnchor">
<a href="#clients" class="anchor" aria-hidden="true"></a>Clients</h3>
<p>The first step in working with any OAuth API is to create a client. This involves you registering for a developer account on the API‚Äôs website and creating a new OAuth app. The process varies from API to API, but at the end of it you‚Äôll get a client id and in most cases a client secret.</p>
<p>(You‚Äôll definitely need this for testing your package, and you‚Äôll probably also baked it into your package for the convenience of your users. Bundling the app is user friendly, but not always possible, particularly if rate limits are enforced on a per-app rather than per-user basis. You should always provide some way for the user to provide their own app.)</p>
<p>If the API provides a way to authenticate your app without the client secret, you should leave it out of your package. But in most cases, you‚Äôll need to include the secret in the package. You can use <code><a href="../reference/obfuscate.html">obfuscate()</a></code> to hide the secret; this is not bulletproof<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;It uses &lt;code&gt;&lt;a href="../reference/secrets.html"&gt;secret_encrypt()&lt;/a&gt;&lt;/code&gt; with a special encryption key that‚Äôs bundled with httr2.&lt;/p&gt;'><sup>3</sup></a>, but in most cases it‚Äôll be easier create a new client than try and steal yours. Additionally, it‚Äôs unusual for an OAuth client to be able to do anything in its own right, so even if someone does steal your secret there‚Äôs not much harm they can do with it.</p>
<p>To obfuscate a secret, call <code><a href="../reference/obfuscate.html">obfuscate()</a></code>:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/obfuscate.html">obfuscate</a></span><span class="op">(</span><span class="st">"secret"</span><span class="op">)</span>
<span class="co">#&gt; obfuscated("jAVrl5mUYH4w6BamzdWxpAr2o_6YBA")</span></code></pre></div>
<p>Then use the client id from the website along with the obfuscated secret to create a client. The following code shows a GitHub OAuth app that I created specifically for this vignette:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">client</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth_client.html">oauth_client</a></span><span class="op">(</span>
  id <span class="op">=</span> <span class="st">"28acfec0674bb3da9f38"</span>,
  secret <span class="op">=</span> <span class="fu"><a href="../reference/obfuscate.html">obfuscated</a></span><span class="op">(</span><span class="st">"J9iiGmyelHltyxqrHXW41ZZPZamyUNxSX1_uKnvPeinhhxET_7FfUs2X0LLKotXY2bpgOMoHRCo"</span><span class="op">)</span>,
  token_url <span class="op">=</span> <span class="st">"https://github.com/login/oauth/access_token"</span>,
  name <span class="op">=</span> <span class="st">"hadley-oauth-test"</span>
<span class="op">)</span></code></pre></div>
<p>You need to figure out the <code>token_url</code> from the <a href="https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps" class="external-link">documentation</a>. I wish I could give good advice about how to find it üòû.</p>
<p>Note that if you print the client the secret is automatically redacted:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">client</span>
<span class="co">#&gt; &lt;httr2_oauth_client&gt;</span>
<span class="co">#&gt;   name: hadley-oauth-test</span>
<span class="co">#&gt;   id: 28acfec0674bb3da9f38</span>
<span class="co">#&gt;   secret: &lt;REDACTED&gt;</span>
<span class="co">#&gt;   token_url: https://github.com/login/oauth/access_token</span>
<span class="co">#&gt;   auth: oauth_client_req_auth_body</span></code></pre></div>
</div>
<div id="flows" class="section level3">
<h3 class="hasAnchor">
<a href="#flows" class="anchor" aria-hidden="true"></a>Flows</h3>
<p>Once you have a client you need to use it with a <strong>flow</strong> in order to get a token. OAuth provides a number of different ‚Äúflows‚Äù, the most common is the ‚Äúauthorisation code‚Äù flow, which is implemented by <code><a href="../reference/req_oauth_auth_code.html">req_oauth_auth_code()</a></code>. You can try it out by running this code:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">token</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/oauth_flow_auth_code.html">oauth_flow_auth_code</a></span><span class="op">(</span><span class="va">client</span>, auth_url <span class="op">=</span> <span class="st">"https://github.com/login/oauth/authorize"</span><span class="op">)</span></code></pre></div>
<p>This flow can‚Äôt be used inside a vignette because it‚Äôs designed specifically for interactive use: it will open a webpage on GitHub that requires you to interactively confirm it‚Äôs OK for this app to use your GitHub account.</p>
<p>Other flows provide different ways of getting the token:</p>
<ul>
<li><p><code><a href="../reference/req_oauth_client_credentials.html">req_oauth_client_credentials()</a></code> is used to allow the client to perform actions on its own behalf (instead of on behalf of some other user). This is typically need if you want to support <strong>service accounts</strong>, which are used in non-interactive environments.</p></li>
<li><p><code><a href="../reference/req_oauth_device.html">req_oauth_device()</a></code> uses the ‚Äúdevice‚Äù flow which is designed for devices like TVs that don‚Äôt have an easy way to enter data. It also works well from the console.</p></li>
<li><p><code><a href="../reference/req_oauth_bearer_jwt.html">req_oauth_bearer_jwt()</a></code> uses a JWT signed by a private key.</p></li>
<li><p><code><a href="../reference/req_oauth_password.html">req_oauth_password()</a></code> exchanges a user name and password for an access token.</p></li>
<li><p><code><a href="../reference/req_oauth_refresh.html">req_oauth_refresh()</a></code> works directly with a refresh token that you already have. It‚Äôs useful for testing.</p></li>
</ul>
<p>There‚Äôs one historically important OAuth flow that httr2 doesn‚Äôt support: the implicit grant flow. This is now <a href="https://developer.okta.com/blog/2019/05/01/is-the-oauth-implicit-flow-dead" class="external-link">mostly deprecated</a> and was never a particularly good fit for native applications because it relies on a technique for returning the access token that only works inside a web browser.</p>
<p>When wrapping an API, you‚Äôll need to carefully read the documentation to figure out which flows are available. Typically you‚Äôll want to use the auth code flow, but if it‚Äôs not available you‚Äôll need to carefully consider the others. An additional wrinkle is that many APIs don‚Äôt implement the flow in exactly the same way as the spec. If your initial attempt doesn‚Äôt work, you‚Äôre going to need to do some sleuthing. This is going to be painful, but unfortunately there‚Äôs no way around it. I recommend using <code><a href="../reference/with_verbosity.html">with_verbosity()</a></code> so you can see exactly what httr2 is sending to the server. You‚Äôll then need to carefully compare this to the API documentation and play ‚Äúspot the difference‚Äù.</p>
</div>
<div id="tokens" class="section level3">
<h3 class="hasAnchor">
<a href="#tokens" class="anchor" aria-hidden="true"></a>Tokens</h3>
<p>The point of a flow is to get a token. You can use <code><a href="../reference/req_auth_bearer_token.html">req_auth_bearer_token()</a></code> to authorise a request with the access token stored inside the token object:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.github.com/user"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_auth_bearer_token.html">req_auth_bearer_token</a></span><span class="op">(</span><span class="va">token</span><span class="op">$</span><span class="va">access_token</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="va">.</span><span class="op">$</span><span class="va">name</span>
<span class="co">#&gt; [1] "Hadley Wickham"</span></code></pre></div>
<p>However, in most cases you won‚Äôt want to do this, but instead allow httr2 to manage the whole process, by switching from <code>oauth_flow_{name}</code> to <code>req_oauth_{name}</code>:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/request.html">request</a></span><span class="op">(</span><span class="st">"https://api.github.com/user"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_oauth_auth_code.html">req_oauth_auth_code</a></span><span class="op">(</span><span class="va">client</span>, auth_url <span class="op">=</span> <span class="st">"https://github.com/login/oauth/authorize"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/req_perform.html">req_perform</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/resp_body_raw.html">resp_body_json</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>This is important because most APIs provide only a short-lived access token that needs to be regularly refreshed using a longer-lived refresh token. httr2 will automatically refresh the token if its expired (i.e.¬†its expiry date is in the past) or if the request errors with a 401 and there‚Äôs an <code>invalid_token</code> error in the <code>WWW-authenticate</code> header.</p>
</div>
<div id="caching" class="section level3">
<h3 class="hasAnchor">
<a href="#caching" class="anchor" aria-hidden="true"></a>Caching</h3>
<p>By default, <code><a href="../reference/req_oauth_auth_code.html">req_oauth_auth_code()</a></code> and friends will cache the token in memory, so that multiple requests in the same session all use the same token. In some cases, you may want to save the token so that it‚Äôs automatically used across sessions. This is easy to do (just set <code>cache_disk = TRUE</code> in <code><a href="../reference/req_oauth_auth_code.html">req_oauth_auth_code()</a></code>) but you need to carefully consider the consequences of saving the user‚Äôs credentials on disk.</p>
<p>httr2 does the best it can to save these credentials securely. They are stored in a local cache directory (<code>rappdirs::user_cache_dir("httr2"))</code> that should only be accessible to the current user, and are encrypted so they will be hard for any package other than httr2 to read. However, there‚Äôs no way to prevent other R code from using httr2 to access them, so if you do choose to cache tokens, you should inform the user and give them the ability to opt-out.</p>
<p>You can see which clients have cached tokens by looking in the cache directory used by httr:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu">rappdirs</span><span class="fu">::</span><span class="fu"><a href="https://rappdirs.r-lib.org/reference/user_cache_dir.html" class="external-link">user_cache_dir</a></span><span class="op">(</span><span class="st">"httr2"</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; character(0)</span></code></pre></div>
<p>httr2 automatically deletes any cached tokens that are older than 30 days whenever it‚Äôs loaded. This means that you‚Äôll need to re-auth at least once a month, but prevents tokens for hanging around on disk long after you‚Äôve forgotten you created them.</p>
</div>
</div>

  </div>
 <div class="col-md-3 d-none d-md-block" id="pkgdown-sidebar">
        <div class="sticky-top">
    <nav id="toc"><h2 data-toc-skip>Contents</h2>

    </nav>
</div>
      </div>

</div>



      <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="http://hadley.nz" class="external-link external-link">Hadley Wickham</a>, <a href="https://www.rstudio.com" class="external-link external-link"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  

  

  </body>
</html>
